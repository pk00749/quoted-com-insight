# 股票公告信息API服务 - 开发任务清单

## 项目概述
基于 FastAPI + AKShare 开发的股票公告信息API服务，专注于提供A股市场的公告数据查询和AI智能总结功能。

## 任务状态说明
- ✅ 已完成
- 🚧 进行中
- ❌ 待开发
- 🔄 需要重构

---

## 任务1: 获取股票公告列表API

**接口**: `GET /api/v1/announcements/{stock_code}`

### 📋 需求描述
- 获取单个股票过去10天的公告信息
- 使用 AKShare 的 `stock_notice_report` 接口
- 返回完整的公告对象列表（不获取正文内容）

### 🎯 期望功能
- 输入：股票代码（如：000001）
- 输出：公告基本信息列表（标题、类别、日期、链接等）
- 时间范围：过去10天
- 数据源：巨潮资讯网（通过AKShare）

### 📤 响应格式
```json
{
    "success": true,
    "data": {
        "announcements": [
            {
                "stock_code": "000001",
                "stock_name": "平安银行",
                "title": "关于召开2024年第三次临时股东大会的通知",
                "category": "临时股东大会",
                "publish_date": "2024-09-17",
                "url": "http://static.cninfo.com.cn/finalpage/..."
            }
        ],
        "total": 1,
        "page": 1,
        "size": 20
    },
    "message": "获取公告成功"
}
```

### 💻 技术实现要点
- 移除现有的 `date` 参数，改为自动获取过去10天
- 使用 `ak.stock_notice_report(symbol='全部', date=日期)` 并按股票代码筛选
- 循环获取过去10天的数��并合并
- **仅返回公告基本信息，不获取URL正文内容**

### ⚠️ 注意事项
- 需要处理AKShare接口可能的异常
- 某些日期可能没有公告数据
- 需要去重处理相同的公告

### 📊 当前状态
✅ **已完成** - 已支持自动获取过去10天公告数据，去重处理，异常处理已实现

---

## 任务2: AI智能总结公告API

**接口**: `POST /api/v1/announcements/{stock_code}/sum`

### 📋 需求描述
- 基于股票代码获取过去10天的公告数据
- **访问每个公告的URL链接，优先通过class为pdf-link的元素获取PDF链接**
- **如获取到PDF链接，则访问该PDF文件，提取PDF正文内容并返回**
- **如未获取到PDF链接，则回退为原有网页正文提取逻辑**
- 使用百炼大模型 Qwen3 对每个公告进行智能总结
- 将所有公告的总结再次汇总为最终的 content

### 🎯 期望功能
- 输入：股票代码
- 处理流程：
  1. 调用任务1方法获取公告列表
  2. **逐个访问每个公告的URL，解析获取正文内容**
  3. 对每个公告正文调用LLM总结成一句话
  4. 将所有单句总结再次调用LLM汇总为最终content（500字内）

### 📤 响应格式
```json
{
    "success": true,
    "data": {
        "summary": "【AI总结功能预留】针对股票：000001的公告总结",
        "content": "基于该股票过去10天的公告内容深度分析：公告1总结句+公告2总结句+...，综合分析得出最终投资观点和关键信息汇总。",
        "word_count": 485,
        "model_info": {
            "model": "qwen3",
            "provider": "百炼大模型",
            "status": "接口预留"
        }
    },
    "message": "AI总结完成（当前为预留接口）"
}
```

### 💻 技术实现要点
- 使用 Playwright 替代 BeautifulSoup 处理动态渲染的网页内容。
- 在 `_extract_announcement_content` 方法中：
  1. 使用 Playwright 加载网页。
  2. 尝试通过 `a.pdf-link` 选择器获取 PDF 链接。
  3. 如果找到 PDF 链接且以 `.pdf` 结尾，则提取 PDF 内容。
  4. 如果未找到 PDF 链接，则回退到提取网页正文内容。
- 确保 Playwright 的浏览器实例在操作完成后正确关闭。

### ⚠️ 注意事项
- 确保开发环境中已安装 Playwright，并运行 `playwright install` 安装浏览器依赖。
- 处理 Playwright 的超时和异常情况，避免因网络问题导致任务失败。
- 确保提取的内容经过清理，去除多余的空格和换行符。

### 📊 当前状态
🚧 **进行中** - 已切换到 Playwright 处理动态渲染的网页内容，待进一步测试和优化。

---

## 任务3: 配置化时间范围

**目标**: 将任务1和任务2的时间范围设置为可配置参数

### 📋 需求描述
- 将时间范围从固定的“过去10天”改为从配置文件 `config.yaml` 中读取。
- 配置文件中新增参数 `announcement_time_range_days`，用于定义时间范围（单位：天）。

### 🎯 期望功能
- 配置文件路径：`app/core/config.yaml`
- 配置示例：
  ```yaml
  announcement_time_range_days: 10
  ```
- 任务1和任务2的时间范围逻辑需改为读取该配置参数。

### 💻 技术实现要点
- 在 `config.yaml` 中新增 `announcement_time_range_days` 参数。
- 修改 `announcement_service.py`，从配置文件中读取时间范围参数。
- 确保读取配置时有默认值（如10天），以防配置文件缺失或参数未定义。

### ⚠️ 注意事项
- 配置文件读取失败时需记录日志并使用默认值。
- 修改后的逻辑需通过单元测试验证。

### 📊 当前状态
❌ **待开发** - 尚未实现配置化时间范围。
