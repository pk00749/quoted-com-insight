# 股票公告信息API服务 - 开发任务清单

## 项目概述
基于 FastAPI + AKShare 开发的股票公告信息API服务，专注于提供A股市场的公告数据查询和AI智能总结功能。

## 任务状态说明
- ✅ 已完成
- 🚧 进行中
- ❌ 待开发
- 🔄 需要重构

---

## 任务1: 获取股票公告列表API

**接口**: `GET /api/v1/announcements/{stock_code}`

### 📋 需求描述
- 获取单个股票过去10天的公告链接列表
- 使用 AKShare 的 `stock_notice_report` 接口
- 返回简洁的公告链接数组

### 🎯 期望功能
- 输入：股票代码（如：000001）
- 输出：公告详情链接列表
- 时间范围：过去10天
- 数据源：巨潮资讯网（通过AKShare）

### 📤 响应格式
```json
{
    "success": true,
    "data": {
        "announcements": [
            {
                "stock_code": "000001",
                "stock_name": "平安银行",
                "title": "关于召开2024年第三次临时股东大会的通知",
                "category": "临时股东大会",
                "publish_date": "2024-09-17",
                "url": "http://static.cninfo.com.cn/finalpage/..."
            }
        ],
        "total": 1,
        "page": 1,
        "size": 20
    },
    "message": "获取公告成功"
}
```

### 💻 技术实现要点
- 移除现有的 `date` 参数，改为自动获取过去10天
- 修改返回格式：从复杂对象结构改为简单的链接数组
- 使用 `ak.stock_notice_report(symbol='全部', date=日期)` 并按股票代码筛选
- 循环获取过去10天的数据并合并

### ⚠️ 注意事项
- 需要处理AKShare接口可能的异常
- 某些日期可能没有公告数据
- 需要去重处理相同的公告链接

### 📊 当前状态
🔄 **需要重构** - 现有代码只支持单日查询，需要扩展为10天范围

---

## 任务2: AI智能总结公告API

**接口**: `POST /api/v1/announcements/summarize`

### 📋 需求描述
- 基于股票代码获取过去10天的公告数据
- 使用百炼大模型 Qwen3 进行智能总结
- 总结字数限制在500字��

### 🎯 期望功能
- 输入：股票代码
- 处理流程：调用任务1接口 → 获取公告内容 → AI总结
- 输出：结构化的总结内容

### 📤 响应格式
```json
{
    "success": true,
    "data": {
        "summary": "【AI总结功能预留】针对股票：000001的公告总结",
        "content": "基于该股票过去10天的公告内容，通过百炼大模型Qwen3分析得出...",
        "word_count": 0,
        "model_info": {
            "model": "qwen3",
            "provider": "百炼大模型",
            "status": "接口预留"
        }
    },
    "message": "AI总结完成（当前为预留接口）"
}
```

### 💻 技术实现要点
- 调用任务1的接口获取公告链接
- 下载并解析PDF公告内容
- 集成百炼大模型API（待实现）
- 实现500字限制的总结逻辑
- 简化响应结构：移除 `key_points`、`impact_analysis`、`investment_suggestion`

### ⚠️ 注意事项
- PDF内容解析的技术选型
- 百炼大模型API的接入配置
- 总结内容的质量控制
- 处理网络请求超时和重试机制

### 📊 当前状态
❌ **待开发** - 当前只有预留接口，需要完整实现

---

## 任务3: Webhook接口（n8n专用）

**接口**: `POST /api/v1/webhook/announcements`

### 📋 需求描述
- 批量处理多个股票代码的公告查询
- 为 n8n 工作流优化的接口设计
- 支持指定日期或默认当天

### 🎯 期望功能
- 输入：股票代码数组 + 可选日期
- 输出：每个股票的公告数据
- 批量处理能力

### 📤 响应格式
```json
{
    "success": true,
    "data": [
        {
            "stock_code": "000001",
            "announcements": {
                "announcements": [...],
                "total": 5,
                "page": 1,
                "size": 50
            }
        }
    ],
    "message": "Webhook处理成功，共处理2只股票"
}
```

### 💻 技术实现要点
- 根据任务1的新需求调整实现逻辑
- 并发处理多个股票代码
- 错误处理和部分失败的情况
- 响应时间控制

### ⚠️ 注意事项
- n8n集成的最佳实践
- 批量请求的性能优化
- 单个股票失败不应影响其他股票

### 📊 当前状态
🔄 **需要重构** - 需要适配任务1的新实现

---

## 任务4: 系统健康检查API

**接口**: `GET /health`

### 📋 需求描述
- 提供系统健康状态检查
- 监控关键组件状态

### 💻 技术实现要点
- 检查AKShare连接状态
- 检查百炼大模型连接状态（可选）
- 返回系统基本信息

### 📊 当前状态
✅ **已完成** - 基础功能已实现

---

## 任务5: 系统信息API

**接口**: `GET /api/v1/system/info`

### 📋 需求描述
- 返回系统版本、配置等信息

### 💻 技术实现要点
- 读取环境变量配置
- 返回API版本信息

### 📊 当前状态
✅ **已完成** - 基础功能已实现

---

## 📅 开发计划

### 阶段1: 核心功能重构 (优先级: 高)
1. **任务1** - 重构获取公告列表API，支持10天范围查询
2. **任务3** - 相应调整Webhook接口

### 阶段2: AI功能开发 (优先级: 中)
3. **任务2** - 实现AI智能总结功能
   - PDF内容解析
   - 百炼大模型集成
   - 总结逻辑优化

### 阶段3: 优化完善 (优先级: 低)
4. 性能优化和错误处理改进
5. 文档完善和测试覆盖

---

## 🔧 技术债务

### 当前代码问题
1. `announcement_service.py` 中的 `get_announcements` 只支持单日查询
2. 返回格式与README.md中的期望不符
3. `summarize_announcement` 方法的响应结构需要简化
4. 缺少PDF内容解析功能
5. 未集成百炼大模型

### 数据模型调整
1. 需要新增或调整Pydantic模型以支持新的响应格式
2. 路由器参数需要与服务方法保持一致

---

## 🧪 测试计划

### 单元测试
- [ ] AKShare接口调用测试
- [ ] 数据处理逻辑测试
- [ ] 错误处理测试

### 集成测试
- [ ] API端点测试
- [ ] n8n集成测试
- [ ] 百炼大模型集成测试

### 性能测试
- [ ] 批量查询性能测试
- [ ] 10天数据获取性能测试
- [ ] 并发处理能力测试

---

## 📝 备注

1. **优先完成任务1**，因为任务2和任务3都依赖于它
2. **PDF解析技术选型**：考虑使用 `PyPDF2`、`pdfplumber` 或 `pymupdf`
3. **百炼大模型集成**：需要获取API密钥和文档
4. **错误处理**：统一使用 `StockAPIException` 进行异常处理
5. **日志记录**：保持详细的操作日志以便调试

## 🔄 更新历史

- **2024-09-17**: 初始任务清单创建
- 基于当前代码状态和README.md需求制定
